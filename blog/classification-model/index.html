<!DOCTYPE html>
<html lang="en">
  <head id="head">
    <meta charset="utf-8">
    <title id="title">
      Deploying a classification model on AWS Lambda with Docker and FastAPI
      | Viny Brasil's Blog
    </title>
    <meta name="description" content="Create and deploy a model to classify selfies and IDs photos on AWS Lambda with Tensorflow, FastAPI and Docker">
    <meta name="twitter:description" content="Create and deploy a model to classify selfies and IDs photos on AWS Lambda with Tensorflow, FastAPI and Docker">
    <meta name="twitter:title" content="Deploying a classification model on AWS Lambda with Docker and FastAPI">
    <meta property="og:title" content="Deploying a classification model on AWS Lambda with Docker and FastAPI">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://kristoff.it/logo.png">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/main.css?bust2">
    <link type="text/css" rel="stylesheet" href="/highlight.css?bust">
    <link rel="stylesheet" type="text/css" href="/fonts.css">
    <link rel="stylesheet" type="text/css" href="/fira_code.css">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="stylesheet" type="text/css" href="/highlight.css">
    
    <script id="MathJax-script" async
    src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
    
    <script defer type="text/javascript" src="https://api.pirsch.io/pirsch.js" id="pirschjs" data-code="CnorXJVVDmhCee3FBtXSQISdHIUmqp3o"></script>
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-Y0TCWKTPYJ"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-Y0TCWKTPYJ');
    </script>
    
  <link type="text/css" rel="stylesheet" href="/term-highlight.css">

  </head>
  <body>
    <!-- <nav id="menu" class="centered"> -->
    <nav>

      <a href="/">Home</a>
      •
      <a href="/projects/">Posts</a>
      •
      <a href="/research/">Research</a>
      •
      <a href="https://linkedin.com/in/vinicyus-brasil" target="_blank">LinkedIn</a>
      •
      <a href="https://github.com/vinybrasil" target="_blank">Github</a>
      
    </nav>
    <div id="content">
      
  <!-- <div style="display:flex; flex-direction:column; align-items:center;">
    <h1 id="header"><a class="reset-a" href="/">Loris Cro</a></h1>
    <small><i>Personal Website</i></small>
    <div style="display:flex; justify-content:center; font-size:small;">
      <a href="/">About</a>
      	&nbsp; • &nbsp;
      <a href="https://twitter.com/croloris">Twitter</a>
      	&nbsp; • &nbsp;
      <a href="https://twitch.tv/kristoff_it">Twitch</a>
      	&nbsp; • &nbsp;
      <a href="https://youtube.com/c/ZigSHOWTIME/">YouTube</a>
      	&nbsp; • &nbsp;
      <a href="https://github.com/kristoff-it">GitHub</a>
    </div>
  </div> -->
  <h1>Deploying a classification model on AWS Lambda with Docker and FastAPI</h1>
  <p class="post-byline">
    <span>August 31, 2022</span>
    •
    <span>12</span>
    min read • by
    <b>Vinicyus Brasil</b>
    <span></span>
  </p>
  <div id="post-description">Create and deploy a model to classify selfies and IDs photos on AWS Lambda with Tensorflow, FastAPI and Docker</div>
  <div id="post-body"><p>Does the user inserted the correct picture when the app requested? That’s a pretty common problem companies faces when creating a onboarding process of a app or a web service. For example, during the onboarding process of a bank the app can ask for a selfie and the user insert a picture of it’s ID. Since in those kind of processes there’s a huge amount of requests at the same time, a manual validation process can’t be used and a machine learning model can be a good alternative. TensorFlow and FastAPI can be used to create that solution.</p><p>We need also to deploy the model on the cloud so it can be available to the app. For that, we can use the serverless service AWS Lambda since it has a low cost and we don’t need to worry about servers.</p><p>In this article a model will be created to classify ID’s/driver’s licenses photos, selfies and invalid photos using TensorFlow, then a API with FastAPI will be created, it’ll be containeraized with Docker and deployed on AWS Lambda. The full repository of the project can be checked <a href="https://github.com/vinybrasil/doc_classifier" target="_blank">here</a>.</p><h2>The data</h2><p>For the model, three types of images are needed: photos of ID’s, selfies and images so called “invalid” ones.</p><p>For the ID’s photos we can use the BID Dataset<a href="https://sol.sbc.org.br/index.php/sibgrapi_estendido/article/view/12997" target="_blank">[1]</a>. It is a dataset with photos of brazilian driver’s licences and ID’s photos with fake data built by brazilian researchers. Below there’s a example of these images.</p><p><figure><img src="/blog/classification-model/rg.jpg">
<figcaption> </figcaption></figure></p><p>To download the dataset, we can use the following code on Google Colab:</p><pre><code>!gdown --id 1Oi88TRcpdjZmJ79WDLb9qFlBNG8q2De6
</code></pre><p>For the selfies and invalid photos we can use the Selfie-Image-Detection-Dataset<a href="https://www.kaggle.com/datasets/jigrubhatt/selfieimagedetectiondataset" target="_blank">[2]</a>, which contains selfies and non-selfies/invalid photos. A example of a selfie</p><p><figure><img src="/blog/classification-model/selfie_example.jpg" width="306" height="306">
<figcaption> </figcaption></figure></p><p>and of a invalid image</p><p><figure><img src="/blog/classification-model/invalid.jpg" width="306" height="306">
<figcaption> </figcaption></figure></p><p>To download the dataset we can use the Kaggle API using the following code also in Google Colab:</p><pre><code class="python">!m<span class="variable">kdir</span> <span class="operator">~</span><span class="operator">/</span>.<span class="variable">kaggle</span>
!t<span class="variable">ouch</span> <span class="operator">~</span><span class="operator">/</span>.<span class="property">kaggle</span><span class="operator">/</span><span class="variable">kaggle</span>.<span class="property">json</span>

<span class="variable">api_token</span> <span class="operator">=</span> {<span class="string">&quot;username&quot;</span>:<span class="string">&quot;yourkaggleusername&quot;</span>,<span class="string">&quot;key&quot;</span>:<span class="string">&quot;YOURKAGGLEAPIKEY&quot;</span>}


<span class="keyword">with</span> <span class="function">open</span>(<span class="string">&apos;/root/.kaggle/kaggle.json&apos;</span>, <span class="string">&apos;w&apos;</span>) <span class="keyword">as</span> <span class="variable">file</span>:
    <span class="variable">json</span>.<span class="function method">dump</span>(<span class="variable">api_token</span>, <span class="variable">file</span>)

!c<span class="variable">hmod</span> <span class="number">600</span> <span class="operator">~</span><span class="operator">/</span>.<span class="variable">kaggle</span><span class="operator">/</span><span class="variable">kaggle</span>.<span class="property">json</span>

!k<span class="variable">aggle</span> <span class="variable">datasets</span> <span class="variable">download</span> <span class="operator">-</span><span class="variable">d</span> <span class="variable">jigrubhatt</span><span class="operator">/</span><span class="variable">selfieimagedetectiondataset</span>
</code></pre>
<p>We now have the full dataset. We can split 80% for the training dataset and the rest for the test dataset.</p><h2>Data preparation and the model</h2><p>We’ll use the images in black and white. Also, the photos to be in the same size. We can use Tensorflow to perform these transformations:</p><pre><code class="python"><span class="variable">SIZE</span> <span class="operator">=</span> <span class="number">64</span>
<span class="variable">img_gray</span> <span class="operator">=</span> <span class="variable">tf</span>.<span class="property">image</span>.<span class="function method">rgb_to_grayscale</span>(<span class="variable">img</span>)
<span class="variable">image_resized</span> <span class="operator">=</span> <span class="variable">tf</span>.<span class="property">image</span>.<span class="function method">resize</span>(<span class="variable">img_gray</span>, (<span class="variable">SIZE</span>, <span class="variable">SIZE</span>))
</code></pre>
<p>The model we’ll train to classify the images is a CNN (Convolutional Neural Network) since it can handle pretty well the task of classifition of images. The code of the model is</p><pre><code class="python"><span class="variable">model</span> <span class="operator">=</span> <span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">models</span>.<span class="function method">Sequential</span>()
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">Conv2D</span>(<span class="number">64</span>, (<span class="number">3</span>, <span class="number">3</span>), <span class="variable">activation</span><span class="operator">=</span><span class="string">&apos;relu&apos;</span>, <span class="variable">input_shape</span><span class="operator">=</span>(<span class="variable">SIZE</span>, <span class="variable">SIZE</span>, <span class="number">1</span>)))
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">MaxPooling2D</span>((<span class="number">2</span>, <span class="number">2</span>)))
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">RandomCrop</span>(<span class="number">16</span>, <span class="number">16</span>))
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">Conv2D</span>(<span class="number">128</span>, (<span class="number">3</span>, <span class="number">3</span>), <span class="variable">activation</span><span class="operator">=</span><span class="string">&apos;relu&apos;</span>))
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">MaxPooling2D</span>((<span class="number">2</span>, <span class="number">2</span>)))
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">Dropout</span>(<span class="number">.1</span>))

<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">Flatten</span>())
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">Dense</span>(<span class="number">256</span>, <span class="variable">activation</span><span class="operator">=</span><span class="string">&apos;relu&apos;</span>))
<span class="variable">model</span>.<span class="function method">add</span>(<span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">layers</span>.<span class="function method">Dense</span>(<span class="number">3</span>))


<span class="variable">model</span>.<span class="function method">compile</span>(<span class="variable">optimizer</span><span class="operator">=</span><span class="string">&apos;adam&apos;</span>,
              <span class="variable">loss</span><span class="operator">=</span><span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">losses</span>.<span class="function method">SparseCategoricalCrossentropy</span>(<span class="variable">from_logits</span><span class="operator">=</span><span class="constant builtin">True</span>), 
              <span class="variable">metrics</span><span class="operator">=</span>[<span class="string">&apos;accuracy&apos;</span>])

<span class="variable">history</span> <span class="operator">=</span> <span class="variable">model</span>.<span class="function method">fit</span>(<span class="variable">train_images</span>, 
                    <span class="variable">train_labels</span>,
                    <span class="variable">validation_split</span><span class="operator">=</span><span class="number">0.2</span>, 
                    <span class="variable">callbacks</span><span class="operator">=</span><span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">callbacks</span>.<span class="function method">EarlyStopping</span>(<span class="variable">patience</span><span class="operator">=</span><span class="number">10</span>), 
                    <span class="variable">epochs</span><span class="operator">=</span><span class="number">300</span>, 
                    <span class="variable">batch_size</span><span class="operator">=</span><span class="number">64</span>)

<span class="variable">plt</span>.<span class="function method">plot</span>(<span class="variable">history</span>.<span class="property">history</span>[<span class="string">&apos;loss&apos;</span>])
<span class="variable">plt</span>.<span class="function method">plot</span>(<span class="variable">history</span>.<span class="property">history</span>[<span class="string">&apos;val_loss&apos;</span>])
</code></pre>
<p>The output of the model is a vector with a score for each class. The softmax function can be used to transform these scores into probabilities. For each $z_{i}$ score of the $i$ class of the K classes, the softmax function can be written as: \[ \sigma(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{K} e^{z_j}} \]</p><p>We can now save the model using a method of the model class:</p><pre><code class="python"><span class="variable">model</span>.<span class="function method">save</span>(<span class="string">&apos;model_v1&apos;</span>)
</code></pre>
<p>It will create a folder and it looks like this</p><p><figure><img src="/blog/classification-model/folder.png" width="187" height="108">
<figcaption> </figcaption></figure></p><p>The full code for training the model can be checked <a href="https://github.com/vinybrasil/doc_classifier/blob/main/notebooks/train_document_classifier.ipynb" target="_blank">here</a>.</p><h2>Creating the API</h2><p>To serve the model, we need to create an API and we’ll use FastAPI because it’s a fast and reliable library.</p><p>The overall structure of the project is the following:</p><pre><code>-&gt; doc_classifier
	-&gt; predictor
    	-&gt; resources
        	-&gt; model_v1
            	-&gt; ...
    	-&gt; make_prediction.py
    -&gt; objects
    	-&gt; output.py
    -&gt; main.py
-&gt; Dockerfile
-&gt; pyproject.toml
-&gt; lambda_function.py
</code></pre><p>We’ll  explain all the files. The main.py file should look like</p><pre><code class="python"><span class="keyword">from</span> <span class="variable">typing</span> <span class="keyword">import</span> <span class="variable">Optional</span>

<span class="keyword">from</span> <span class="variable">fastapi</span> <span class="keyword">import</span> <span class="variable">FastAPI</span>

<span class="keyword">from</span> <span class="variable">doc_classifier</span>.<span class="variable">objects</span>.<span class="variable">output</span> <span class="keyword">import</span> <span class="variable">OutputPrediction</span>
<span class="keyword">from</span> <span class="variable">doc_classifier</span>.<span class="variable">predictor</span>.<span class="variable">make_prediction</span> <span class="keyword">import</span> <span class="variable">predict</span>

<span class="variable">app</span> <span class="operator">=</span> <span class="function">FastAPI</span>()

<span class="function">@app.get(&quot;/health_check&quot;)</span>
<span class="keyword">def</span> <span class="function">read_root</span>():
    <span class="keyword">return</span> {<span class="string">&quot;Ping&quot;</span>: <span class="string">&quot;Pong&quot;</span>}

<span class="function">@app.post(&quot;/classifier&quot;)</span>
<span class="keyword">def</span> <span class="function">classifier</span>(<span class="variable">req</span>: <span class="variable">Optional</span>[<span class="type">dict</span>]):
    <span class="variable">prediction</span> <span class="operator">=</span> <span class="function">predict</span>(<span class="variable">req</span>[<span class="string">&quot;input_photo&quot;</span>])
    <span class="keyword">return</span> <span class="function">OutputPrediction</span>(
        <span class="variable">leadId</span><span class="operator">=</span><span class="variable">req</span>[<span class="string">&quot;leadId&quot;</span>], <span class="variable">photoHash</span><span class="operator">=</span><span class="variable">prediction</span>[<span class="number">1</span>], <span class="variable">prediction</span><span class="operator">=</span><span class="variable">prediction</span>[<span class="number">0</span>]
    )
</code></pre>
<p>The classifier route is the one we’ll use to make the prediction. It recieves a dictionary containing two keys: the input_photo coded in base64 in a string format and the lead_id key to identification purposes. A example of the request in Python would be:</p><pre><code class="python"><span class="keyword">import</span> <span class="variable">base64</span>
<span class="keyword">import</span> <span class="variable">requests</span>

<span class="variable">encoded_string</span> <span class="operator">=</span> <span class="variable">base64</span>.<span class="function method">b64encode</span>(<span class="function">open</span>(<span class="string">&quot;test_doc_2.jpg&quot;</span>, <span class="string">&quot;rb&quot;</span>).<span class="function method">read</span>())
<span class="variable">encoded_string_utf</span> <span class="operator">=</span> <span class="variable">encoded_string</span>.<span class="function method">decode</span>(<span class="string">&quot;utf-8&quot;</span>)

<span class="function">print</span>(
     <span class="variable">requests</span>.<span class="function method">post</span>(
         <span class="string">&quot;http://localhost:8000/classifier&quot;</span>,
         <span class="variable">json</span><span class="operator">=</span>{<span class="string">&quot;input_photo&quot;</span>: <span class="variable">encoded_string_utf</span>, <span class="string">&quot;leadId&quot;</span>: <span class="string">&quot;f8cad38c-c4f3-4f50-ab23-5262033bfef1&quot;</span>},
     ).<span class="property">text</span>
 )
</code></pre>
<p>We can test the API by running it with uvicorn:</p><pre><code class="python"><span class="keyword">import</span> <span class="variable">uvicorn</span>

<span class="keyword">if</span> <span class="variable">__name__</span> <span class="operator">==</span> <span class="string">&quot;__main__&quot;</span>:
    <span class="variable">uvicorn</span>.<span class="function method">run</span>(<span class="string">&quot;doc_classifier.main:app&quot;</span>, <span class="variable">host</span><span class="operator">=</span><span class="string">&quot;0.0.0.0&quot;</span>, <span class="variable">port</span><span class="operator">=</span><span class="number">8000</span>, <span class="variable">reload</span><span class="operator">=</span><span class="constant builtin">True</span>)
</code></pre>
<p>When the request in made, the function calls the predict function of the make_prediction.py file. The function decodes the image, turns it to grayscale, resizes it and call the model to make the prediction.</p><pre><code class="python"><span class="keyword">import</span> <span class="variable">base64</span>
<span class="keyword">import</span> <span class="variable">io</span>
<span class="keyword">import</span> <span class="variable">os</span>

<span class="keyword">import</span> <span class="variable">numpy</span> <span class="keyword">as</span> <span class="variable">np</span>
<span class="keyword">import</span> <span class="variable">tensorflow</span> <span class="keyword">as</span> <span class="variable">tf</span>
<span class="keyword">from</span> <span class="variable">PIL</span> <span class="keyword">import</span> <span class="variable">Image</span>
<span class="keyword">from</span> <span class="variable">scipy</span>.<span class="variable">special</span> <span class="keyword">import</span> <span class="variable">softmax</span>
<span class="keyword">import</span> <span class="variable">imagehash</span>

<span class="keyword">from</span> <span class="variable">doc_classifier</span>.<span class="variable">objects</span>.<span class="variable">output</span> <span class="keyword">import</span> <span class="variable">Prediction</span>, <span class="variable">ProbabilitiesPrediction</span>, <span class="variable">RawPrediction</span>

<span class="variable">SIZE</span> <span class="operator">=</span> <span class="number">64</span>

<span class="keyword">def</span> <span class="function">load_model</span>():
    <span class="variable">package_dir</span> <span class="operator">=</span> <span class="variable">os</span>.<span class="property">path</span>.<span class="function method">dirname</span>(<span class="variable">os</span>.<span class="property">path</span>.<span class="function method">abspath</span>(<span class="variable">__file__</span>))
    <span class="variable">thefile</span> <span class="operator">=</span> <span class="variable">os</span>.<span class="property">path</span>.<span class="function method">join</span>(<span class="variable">package_dir</span>, <span class="string">&quot;resources&quot;</span>, <span class="string">&quot;model_v8&quot;</span>)
    <span class="variable">model</span> <span class="operator">=</span> <span class="variable">tf</span>.<span class="property">keras</span>.<span class="property">models</span>.<span class="function method">load_model</span>(<span class="variable">thefile</span>)
    <span class="keyword">return</span> <span class="variable">model</span>


<span class="keyword">def</span> <span class="function">bytes_to_array</span>(<span class="variable">image_b64</span>):
    <span class="variable">image_decoded</span> <span class="operator">=</span> <span class="variable">base64</span>.<span class="function method">b64decode</span>(<span class="variable">image_b64</span>)
    <span class="variable">image</span> <span class="operator">=</span> <span class="variable">Image</span>.<span class="function method">open</span>(<span class="variable">io</span>.<span class="function method">BytesIO</span>(<span class="variable">image_decoded</span>))
    <span class="variable">hash_photo</span> <span class="operator">=</span> <span class="variable">imagehash</span>.<span class="function method">average_hash</span>(<span class="variable">image</span>)
    <span class="keyword">return</span> <span class="variable">np</span>.<span class="function method">asarray</span>(<span class="variable">image</span>), <span class="variable">hash_photo</span>


<span class="keyword">def</span> <span class="function">prepare_image</span>(<span class="variable">img</span>):
    <span class="variable">img_gray</span> <span class="operator">=</span> <span class="variable">tf</span>.<span class="property">image</span>.<span class="function method">rgb_to_grayscale</span>(<span class="variable">img</span>)
    <span class="variable">image_resized</span> <span class="operator">=</span> <span class="variable">tf</span>.<span class="property">image</span>.<span class="function method">resize</span>(<span class="variable">img_gray</span>, (<span class="variable">SIZE</span>, <span class="variable">SIZE</span>))
    <span class="keyword">return</span> <span class="variable">np</span>.<span class="function method">asarray</span>(<span class="variable">image_resized</span>).<span class="function method">reshape</span>(<span class="number">1</span>, <span class="variable">SIZE</span>, <span class="variable">SIZE</span>, <span class="number">1</span>)


<span class="keyword">def</span> <span class="function">predict</span>(<span class="variable">image_b64</span>):
    <span class="variable">model</span> <span class="operator">=</span> <span class="function">load_model</span>()
    <span class="variable">image_as_array</span>, <span class="variable">hash_photo</span> <span class="operator">=</span> <span class="function">bytes_to_array</span>(<span class="variable">image_b64</span>)
     
    <span class="variable">image_ready</span> <span class="operator">=</span> <span class="function">prepare_image</span>(<span class="variable">image_as_array</span>)
    <span class="variable">raw_prediction</span> <span class="operator">=</span> <span class="variable">model</span>.<span class="function method">predict</span>(<span class="variable">image_ready</span>)
    <span class="variable">max_prob</span> <span class="operator">=</span> <span class="variable">np</span>.<span class="function method">argmax</span>(<span class="function">softmax</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>]))
    <span class="variable">class_predicted</span> <span class="operator">=</span> [<span class="string">&quot;selfie&quot;</span>, <span class="string">&quot;document&quot;</span>, <span class="string">&quot;invalid&quot;</span>][<span class="variable">max_prob</span>]

    <span class="variable">prediction</span> <span class="operator">=</span> <span class="function">Prediction</span>(
        <span class="variable">raw_prediction</span><span class="operator">=</span><span class="function">RawPrediction</span>(
            <span class="variable">selfie_score</span><span class="operator">=</span><span class="function">list</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>])[<span class="number">0</span>],
            <span class="variable">document_score</span><span class="operator">=</span><span class="function">list</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>])[<span class="number">1</span>],
            <span class="variable">invalid_score</span><span class="operator">=</span><span class="function">list</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>])[<span class="number">2</span>]
        ),
        <span class="variable">probabilities</span><span class="operator">=</span><span class="function">ProbabilitiesPrediction</span>(
            <span class="variable">selfie_probability</span><span class="operator">=</span><span class="function">list</span>(<span class="function">softmax</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>]))[<span class="number">0</span>],
            <span class="variable">document_probability</span><span class="operator">=</span><span class="function">list</span>(<span class="function">softmax</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>]))[<span class="number">1</span>],
            <span class="variable">invalid_probability</span><span class="operator">=</span><span class="function">list</span>(<span class="function">softmax</span>(<span class="variable">raw_prediction</span>[<span class="number">0</span>]))[<span class="number">2</span>]
        ),
        <span class="variable">class_predicted</span><span class="operator">=</span><span class="variable">class_predicted</span>,
    )
    <span class="keyword">return</span> <span class="variable">prediction</span>, <span class="function">str</span>(<span class="variable">hash_photo</span>)
</code></pre>
<p>The function returns a object of the Prediction class and a hash of the image to be store in a database so we don’t need to classify the same image twice. The prediction class is built in the output.py file:</p><pre><code class="python"><span class="keyword">import</span> <span class="variable">uuid</span>
<span class="keyword">from</span> <span class="variable">typing</span> <span class="keyword">import</span> <span class="variable">Optional</span>

<span class="keyword">import</span> <span class="variable">arrow</span>
<span class="keyword">from</span> <span class="variable">pydantic</span> <span class="keyword">import</span> <span class="variable">BaseModel</span>, <span class="variable">Field</span>, <span class="variable">StrictStr</span>


<span class="keyword">class</span> <span class="variable">RawPrediction</span>(<span class="variable">BaseModel</span>):
    <span class="variable">selfie_score</span>: <span class="variable">Optional</span>[<span class="type">float</span>]
    <span class="variable">document_score</span>: <span class="variable">Optional</span>[<span class="type">float</span>]
    <span class="variable">invalid_score</span>: <span class="variable">Optional</span>[<span class="type">float</span>]


<span class="keyword">class</span> <span class="variable">ProbabilitiesPrediction</span>(<span class="variable">BaseModel</span>):
    <span class="variable">selfie_probability</span>: <span class="variable">Optional</span>[<span class="type">float</span>]
    <span class="variable">document_probability</span>: <span class="variable">Optional</span>[<span class="type">float</span>]
    <span class="variable">invalid_probability</span>: <span class="variable">Optional</span>[<span class="type">float</span>]


<span class="keyword">class</span> <span class="variable">Prediction</span>(<span class="variable">BaseModel</span>):
    <span class="variable">raw_prediction</span>: <span class="variable">Optional</span>[<span class="type">RawPrediction</span>] <span class="operator">=</span> <span class="constant builtin">None</span>
    <span class="variable">probabilities</span>: <span class="variable">Optional</span>[<span class="type">ProbabilitiesPrediction</span>] <span class="operator">=</span> <span class="constant builtin">None</span>
    <span class="variable">class_predicted</span>: <span class="variable">Optional</span>[<span class="type">StrictStr</span>] <span class="operator">=</span> <span class="string">&quot;&quot;</span>


<span class="keyword">class</span> <span class="variable">OutputPrediction</span>(<span class="variable">BaseModel</span>):
    <span class="variable">leadId</span>: <span class="variable">Optional</span>[<span class="type">StrictStr</span>]
    <span class="variable">photoHash</span>: <span class="variable">Optional</span>[<span class="type">StrictStr</span>] <span class="operator">=</span> <span class="string">&quot;&quot;</span>
    <span class="variable">prediction</span>: <span class="variable">Optional</span>[<span class="type">Prediction</span>] <span class="operator">=</span> <span class="constant builtin">None</span>
    <span class="variable">requestId</span>: <span class="variable">Optional</span>[<span class="type">str</span>] <span class="operator">=</span> <span class="function">Field</span>(<span class="variable">default_factory</span><span class="operator">=</span><span class="variable">uuid</span>.<span class="property">uuid4</span>)
    <span class="variable">timestamp</span>: <span class="variable">Optional</span>[<span class="type">str</span>] <span class="operator">=</span> <span class="function">Field</span>(<span class="variable">default_factory</span><span class="operator">=</span><span class="variable">arrow</span>.<span class="property">now</span>)
</code></pre>
<p>When the predict function returns the Prediction object, the classifier function of the main.py file combines the Predition object with the lead_id of the original request to build the OutputPrediction object. A response would be:</p><p><figure><img src="/blog/classification-model/result0.png" width="790" height="543">
<figcaption> </figcaption></figure></p><p>For dependencies management Poetry can be used. It’s a package in Python similar to pip. In the root folder we can write</p><pre><code>poetry init
</code></pre><p>It’ll create a pyproject.toml file, where the details of the project can be written. The full file is</p><pre><code>[tool.poetry]
name = &quot;doc_classifier&quot;
version = &quot;0.1.0&quot;
description = &quot;&quot;
authors = [&quot;vinybrasil &lt;vinicyusbrasil1@hotmail.com&gt;&quot;]

[tool.poetry.dependencies]
python = &quot;&gt;=3.8,&lt;3.11&quot;
tensorflow = &quot;^2.8.2&quot;
pillow = &quot;^9.2.0&quot;
arrow = &quot;^1.2.2&quot;
scipy = &quot;^1.9.0&quot;
fastapi = &quot;^0.79.0&quot;
imagehash = &quot;^4.2.1&quot;

[tool.poetry.dev-dependencies]

[build-system]
requires = [&quot;poetry-core&gt;=1.0.0&quot;]
build-backend = &quot;poetry.core.masonry.api&quot;
</code></pre><p>With that we can install the API as a python package:</p><pre><code>poetry install
</code></pre><p>In order to deploy on AWS Lambda, we need to create the lambda_function.py file in the root of the projects. It simply loads the app object of the main.py and calls the Mangum library.</p><pre><code class="python"><span class="keyword">from</span> <span class="variable">mangum</span> <span class="keyword">import</span> <span class="variable">Mangum</span>
<span class="keyword">from</span> <span class="variable">doc_classifier</span>.<span class="variable">main</span> <span class="keyword">import</span> <span class="variable">app</span>

<span class="variable">lambda_handler</span> <span class="operator">=</span> <span class="function">Mangum</span>(<span class="variable">app</span>, <span class="variable">lifespan</span><span class="operator">=</span><span class="string">&quot;off&quot;</span>)
</code></pre>
<p>And that’s it for the API.</p><h1>Deploying the API</h1><p>With API ready, we can now containerize the with Docker. We’ll be using the AWS version of Linux on the Docker container. On the Dockerfile we should write:</p><pre><code>FROM public.ecr.aws/lambda/python:3.8

COPY doc_classifier/ ${LAMBDA_TASK_ROOT}/doc_classifier/
COPY lambda_function.py ${LAMBDA_TASK_ROOT}
COPY pyproject.toml ${LAMBDA_TASK_ROOT}


ENV PATH /home/$(python3 -m site --user-base)/.local/bin:${PATH}

RUN pip install poetry mangum  &amp;&amp; poetry config virtualenvs.create false &amp;&amp; poetry update &amp;&amp; poetry install

CMD [ &quot;lambda_function.lambda_handler&quot; ]
</code></pre><p>This implementation is based on the tutorial by AWS<a href="https://docs.aws.amazon.com/lambda/latest/dg/images-create.html" target="_blank">[3]</a>. The LAMBDA_TASK_ROOT is a variable with the value /var/task.</p><p>Before creating the container, a repository in the AWS ECR (Elastic Container Registry) is needed. It can be created on AWS managment tool, searching for ECR, clicking in “create repository” and filling the informations needed.</p><p>[ ]($image.asset(“ecr.png “))</p><p>Following Cardoso’s tutorial<a href="https://medium.com/dataengineerbr/how-to-run-aws-lambda-locally-on-your-computer-with-docker-containers-533a3add1b45" target="_blank">[4]</a>, the container can be created by tipyng</p><pre><code>docker build -t doc_classifier . 
</code></pre><p>Tagging the image:</p><pre><code>docker tag doc_classifier:latest AWSUSERIDHERE.dkr.ecr.us-east-1.amazonaws.com/doc_classifier:latest
</code></pre><p>Give permission to your CLI to access ECR:  [https://docs.aws.amazon.com/lambda/latest/dg/images-create.html]</p><pre><code>aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin AWSUSERIDHERE.dkr.ecr.us-east-1.amazonaws.com
</code></pre><p>Pushing it to the repository:</p><pre><code>docker push AWSUSERIDHERE.dkr.ecr.us-east-1.amazonaws.com/doc_classifier:latest
</code></pre><p>We can know see the image in ECR:</p><p><figure><img src="/blog/classification-model/ectr_rep.png" width="994" height="415">
<figcaption> </figcaption></figure></p><p>The Lambda function can now be created. Searching for “Lambda” in the AWS search bar and clicking in “create function”, the following screen should apper:</p><p><figure><img src="/blog/classification-model/lambda1.png">
<figcaption> </figcaption></figure></p><p>By selecting to create the lambda function with a container, the container can be selected in the “browse images” button.</p><p><figure><img src="/blog/classification-model/lambda2.png">
<figcaption> </figcaption></figure></p><p>Under “Container image overrides” the variable “/var/task” shall be set in the WORKDIR box.</p><p><figure><img src="/blog/classification-model/lambda3.png" width="864" height="389">
<figcaption> </figcaption></figure></p><p>Finish the creation step by clicking  in the “create function” button. Since the model consumes some memory, we must increase the memory and the timeout limit of the lambda function.</p><p><figure><img src="/blog/classification-model/lambda4.png" width="899" height="359">
<figcaption> </figcaption></figure></p><p>The last step is to set the API Gateway as a trigger so we can call our model with a HTTP request. By searching by “API Gateway” in AWS search bar and clicking in API, we can select to create a new one and to create a HTTP API:</p><p><figure><img src="/blog/classification-model/papi1.png" width="571" height="206">
<figcaption> </figcaption></figure></p><p>The API can now be integrated it with the Lambda function created earlier:</p><p><figure><img src="/blog/classification-model/papi2.png" width="554" height="661">
<figcaption> </figcaption></figure></p><p>The last step is to map the routes of the API Gateway to the routes of the API inside the Lambda function:</p><p><figure><img src="/blog/classification-model/papi3.png" width="572" height="521">
<figcaption> </figcaption></figure></p><p>And that’s it. By finishing the creation and going back to the lambda function screen, we shall see the following screen:</p><p><figure><img src="/blog/classification-model/papi35.png" width="939" height="382">
<figcaption> </figcaption></figure></p><p>The routes we created are now related to a URL:</p><p><figure><img src="/blog/classification-model/papi4.png">
<figcaption> </figcaption></figure></p><p>So now our function can receive HTTP requests in those URLS. Using the following code to test:</p><pre><code class="python"><span class="keyword">import</span> <span class="variable">base64</span>
<span class="keyword">import</span> <span class="variable">requests</span>

<span class="variable">encoded_string</span> <span class="operator">=</span> <span class="variable">base64</span>.<span class="function method">b64encode</span>(<span class="function">open</span>(<span class="string">&quot;test_doc_2.jpg&quot;</span>, <span class="string">&quot;rb&quot;</span>).<span class="function method">read</span>())
<span class="variable">encoded_string_utf</span> <span class="operator">=</span> <span class="variable">encoded_string</span>.<span class="function method">decode</span>(<span class="string">&quot;utf-8&quot;</span>)

<span class="function">print</span>(
     <span class="variable">requests</span>.<span class="function method">post</span>(
         <span class="string">&quot;https://k1udh87ek6.execute-api.us-east-1.amazonaws.com/classifier&quot;</span>,
         <span class="variable">json</span><span class="operator">=</span>{<span class="string">&quot;input_photo&quot;</span>: <span class="variable">encoded_string_utf</span>, <span class="string">&quot;leadId&quot;</span>: <span class="string">&quot;f8cad38c-c4f3-4f50-ab23-5262033bfef1&quot;</span>},
     ).<span class="property">text</span>
 )
</code></pre>
<p>We shall receive the following response:</p><p><figure><img src="/blog/classification-model/result1.png" width="807" height="663">
<figcaption> </figcaption></figure></p><p>That’s it. Our model can know give predictions to photos, everything in the cloud.  Feel free to comment, explore the code on Github or contact me via LinkedIn. Keep on learning :D</p><h1>References</h1><p>[1] BID Dataset: a challenge dataset for document processing tasks.  <a href="https://sol.sbc.org.br/index.php/sibgrapi_estendido/article/view/12997" target="_blank">https://sol.sbc.org.br/index.php/sibgrapi_estendido/article/view/12997</a></p><p>[2] Selfie-Image-Detection-Dataset. <a href="https://www.kaggle.com/datasets/jigrubhatt/selfieimagedetectiondataset" target="_blank">https://www.kaggle.com/datasets/jigrubhatt/selfieimagedetectiondataset</a></p><p>[3] Creating Lambda container images. <a href="https://docs.aws.amazon.com/lambda/latest/dg/images-create.html" target="_blank">https://docs.aws.amazon.com/lambda/latest/dg/images-create.html</a></p><p>[4] How to run AWS Lambda on your computer using Docker containers. <a href="https://medium.com/dataengineerbr/how-to-run-aws-lambda-locally-on-your-computer-with-docker-containers-533a3add1b45" target="_blank">https://medium.com/dataengineerbr/how-to-run-aws-lambda-locally-on-your-computer-with-docker-containers-533a3add1b45</a></p></div>
  <div id="footnotes"></div>
  <div>
    <small><a href="/index.xml" rel="alternate" type="application/rss+xml">RSS feed</a></small>
  </div>
  <hr>
  <div id="prev-next">
    <span>
      <a href="/blog/kafka-python-consumer-producer/">←
        <span>An asynchronous Consumer and Producer API for Kafka with FastAPI in Python</span></a>
    </span>
    <span>&nbsp; • &nbsp;</span>
    <span>
      <a href="/blog/sqs-lambda/"><span>Trigger a AWS Lambda with a SQS message with Python</span>
        →</a>
    </span>
    <small>&nbsp; or &nbsp;</small>
    <small>
      <a href="/">Back to the Homepage</a>
    </small>
  </div>

    </div>
  </body>
</html>