<!DOCTYPE html>
<html lang="en">
  <head id="head">
    <meta charset="utf-8">
    <title id="title">
      What is Zig&apos;s Comptime?
      | Vini Brasil's Blog
    </title>
    <meta name="description" content="Let&apos;s take a quick look at what compile-time execution looks like in Zig.">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@croloris">
    <meta name="twitter:image" content="https://kristoff.it/logo.png">
    <meta name="twitter:author" content="@croloris">
    <meta name="twitter:description" content="Let&apos;s take a quick look at what compile-time execution looks like in Zig.">
    <meta name="twitter:title" content="What is Zig&apos;s Comptime?">
    <meta property="og:title" content="What is Zig&apos;s Comptime?">
    <meta property="og:type" content="website">
    <meta property="og:image" content="https://kristoff.it/logo.png">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;0,900;1,300;1,400;1,700;1,900&family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="/main.css?bust2">
    <link type="text/css" rel="stylesheet" href="/highlight.css?bust">
    <link rel="stylesheet" type="text/css" href="/fonts.css">
    <link rel="stylesheet" type="text/css" href="/fira_code.css">
    <link rel="stylesheet" type="text/css" href="/style.css">
    <link rel="stylesheet" type="text/css" href="/highlight.css">
    
    <script defer type="text/javascript" src="https://api.pirsch.io/pirsch.js" id="pirschjs" data-code="CnorXJVVDmhCee3FBtXSQISdHIUmqp3o"></script>
    
  <link type="text/css" rel="stylesheet" href="/term-highlight.css">

  </head>
  <body>
    <!-- <nav id="menu" class="centered"> -->
    <nav>
      <!-- <a href="/">Home</a>
      •
      <a href="$site.page('quickstart').link()">Get Started</a>
      •
      <a href="$site.page('docs').link()">Documentation</a>
      •
      <a href="$site.page('community').link()">Community</a>
      •
      <a href="$site.page('log').link()">Devlog</a>
      •
      <a href="https://github.com/kristoff-it/zine" target="_blank">
        Code
      </a> -->

      <a href="/">Home</a>
      •
      <a href="/">Projects</a>
      •
      <a href="/">Research</a>
      •
      <a href="/">LinkedIn</a>
      •
      <a href="/">Github</a>
      •
      <a href="/" target="_blank">
        Lattes
      </a>
    </nav>
    <div id="content">
      
  <!-- <div style="display:flex; flex-direction:column; align-items:center;">
    <h1 id="header"><a class="reset-a" href="/">Loris Cro</a></h1>
    <small><i>Personal Website</i></small>
    <div style="display:flex; justify-content:center; font-size:small;">
      <a href="/">About</a>
      	&nbsp; • &nbsp;
      <a href="https://twitter.com/croloris">Twitter</a>
      	&nbsp; • &nbsp;
      <a href="https://twitch.tv/kristoff_it">Twitch</a>
      	&nbsp; • &nbsp;
      <a href="https://youtube.com/c/ZigSHOWTIME/">YouTube</a>
      	&nbsp; • &nbsp;
      <a href="https://github.com/kristoff-it">GitHub</a>
    </div>
  </div> -->
  <h1>What is Zig&apos;s Comptime?</h1>
  <p class="post-byline">
    <span>August 05, 2019</span>
    •
    <span>11</span>
    min read • by
    <b>Loris Cro</b>
    <span></span>
  </p>
  <div id="post-description">Let's take a quick look at what compile-time execution looks like in Zig.</div>
  <div id="post-body"><p>If you’ve only experienced compile-time execution in the form of macros, generics or codegen, be ready to be surprised by what Zig can do.</p><h2>What is Zig</h2><p>Zig is a new general-purpose programming language developed by Andrew Kelley. While still under heavy development, I think the language is already showing great promise. Zig aims to be a better C, similarly to how Rust can be understood as a better C++, generally speaking. Zig has no garbage collection, no built-in event loops, nor other runtime machinery of that level. It’s lean just like C, and in fact it can interoperate with C pretty easily. For a complete overview checkout <a href="https://ziglang.org" target="_blank">https://ziglang.org</a>.</p><p>Now that you got a general idea about the level of abstraction in which Zig operates, you won’t be surprised to know that there is absolutely no support for reflection at runtime; but what you can’t do at runtime, you can certainly do at compile-time.</p><h2>Running code at compile-time</h2><p>Let’s start with the basics: using the <code>comptime</code> keyword to run arbitrary code at compilation-time.</p><h4>Compile-time function calls</h4><p>The following code uses a function to decide the length of a statically-allocated array.</p><pre><code class="zig"><span class="keyword function">fn</span> <span class="function">multiply</span><span class="punctuation bracket">(</span><span class="variable parameter">a</span><span class="punctuation delimiter">:</span> <span class="type builtin">i64</span><span class="punctuation delimiter">,</span> <span class="variable parameter">b</span><span class="punctuation delimiter">:</span> <span class="type builtin">i64</span><span class="punctuation bracket">)</span> <span class="type builtin">i64</span> <span class="punctuation bracket">{</span>
    <span class="keyword return">return</span> <span class="variable">a</span> <span class="operator">*</span> <span class="variable">b</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>

<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">main</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span> <span class="type builtin">void</span> <span class="punctuation bracket">{</span>
    <span class="keyword">const</span> <span class="variable">len</span> <span class="operator">=</span> <span class="keyword modifier">comptime</span> <span class="function call">multiply</span><span class="punctuation bracket">(</span><span class="number">4</span><span class="punctuation delimiter">,</span> <span class="number">5</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword">const</span> <span class="variable">my_static_array</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="variable">len</span><span class="punctuation bracket">]</span><span class="type builtin">u8</span> <span class="operator">=</span> <span class="constant builtin">undefined</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>Note how the function definition doesn’t have any attribute that states it must be available at compile-time. It’s just a normal function, and we request its compile-time execution at the call site.</p><h4>Compile-time blocks</h4><p>You can also use <code>comptime</code> to define a compile-time block inside a function. The following example is a case-insensitive string compare function that is optimized for the use-case where one of the two strings is hardcoded. Compile-time execution ensures that the function doesn’t get misused.</p><pre><code class="zig"><span class="comment">// Compares two strings ignoring case (ascii strings only).</span>
<span class="comment">// Specialzied version where `uppr` is comptime known and *uppercase*.</span>
<span class="keyword function">fn</span> <span class="function">insensitive_eql</span><span class="punctuation bracket">(</span><span class="keyword modifier">comptime</span> <span class="variable parameter">uppr</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="punctuation bracket">]</span><span class="keyword">const</span> <span class="type builtin">u8</span><span class="punctuation delimiter">,</span> <span class="variable parameter">str</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="punctuation bracket">]</span><span class="keyword">const</span> <span class="type builtin">u8</span><span class="punctuation bracket">)</span> <span class="type builtin">bool</span> <span class="punctuation bracket">{</span>
    <span class="keyword modifier">comptime</span> <span class="punctuation bracket">{</span>
        <span class="keyword">var</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">;</span>
        <span class="keyword repeat">while</span> <span class="punctuation bracket">(</span><span class="variable">i</span> <span class="operator">&lt;</span> <span class="variable">uppr</span><span class="punctuation delimiter">.</span><span class="variable member">len</span><span class="punctuation bracket">)</span> <span class="punctuation delimiter">:</span> <span class="punctuation bracket">(</span><span class="variable">i</span> <span class="operator">+=</span> <span class="number">1</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
            <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">uppr</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span> <span class="operator">&gt;=</span> <span class="character">&apos;a&apos;</span> <span class="keyword operator">and</span> <span class="variable">uppr</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span> <span class="operator">&lt;=</span> <span class="character">&apos;z&apos;</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
                <span class="function builtin">@compileError</span><span class="punctuation bracket">(</span><span class="string">&quot;`uppr` must be all uppercase&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
            <span class="punctuation bracket">}</span>
        <span class="punctuation bracket">}</span>
    <span class="punctuation bracket">}</span>
    <span class="keyword">var</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">;</span>
    <span class="keyword repeat">while</span> <span class="punctuation bracket">(</span><span class="variable">i</span> <span class="operator">&lt;</span> <span class="variable">uppr</span><span class="punctuation delimiter">.</span><span class="variable member">len</span><span class="punctuation bracket">)</span> <span class="punctuation delimiter">:</span> <span class="punctuation bracket">(</span><span class="variable">i</span> <span class="operator">+=</span> <span class="number">1</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
        <span class="keyword">const</span> <span class="variable">val</span> <span class="operator">=</span> <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">str</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span> <span class="operator">&gt;=</span> <span class="character">&apos;a&apos;</span> <span class="keyword operator">and</span> <span class="variable">str</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span> <span class="operator">&lt;=</span> <span class="character">&apos;z&apos;</span><span class="punctuation bracket">)</span>
            <span class="variable">str</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span> <span class="operator">-</span> <span class="number">32</span>
        <span class="keyword conditional">else</span>
            <span class="variable">str</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span><span class="punctuation delimiter">;</span>
        <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">val</span> <span class="operator">!=</span> <span class="variable">uppr</span><span class="punctuation bracket">[</span><span class="variable">i</span><span class="punctuation bracket">]</span><span class="punctuation bracket">)</span> <span class="keyword return">return</span> <span class="variable">false</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span>
    <span class="keyword return">return</span> <span class="variable">true</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>

<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">main</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span> <span class="type builtin">void</span> <span class="punctuation bracket">{</span>
    <span class="keyword">const</span> <span class="variable">x</span> <span class="operator">=</span> <span class="function call">insensitive_eql</span><span class="punctuation bracket">(</span><span class="string">&quot;Hello&quot;</span><span class="punctuation delimiter">,</span> <span class="string">&quot;hElLo&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>Compilation of this program fails and produces the following output.</p><pre><code>$ zig build-exe ieq.zig                                       
/Users/loriscro/ieq.zig:8:17: error: `uppr` must be all uppercase
                @compileError(&quot;`uppr` must be all uppercase&quot;);
                ^
/Users/loriscro/ieq.zig:24:30: note: called from here
    const x = insensitive_eql(&quot;Hello&quot;, &quot;hElLo&quot;);

</code></pre><h4>Compile-time code elision</h4><p>Zig can statically resolve control flow expressions that depend on compile-time known values. For example, you can force loop unrolling on <code>while</code> / <code>for</code> loops and elide branches from <code>if</code> / <code>switch</code> statements. The following program asks the user for a number and then iteratively applies a list of operations to it:</p><pre><code class="zig"><span class="keyword">const</span> <span class="variable">builtin</span> <span class="operator">=</span> <span class="keyword import">@import</span><span class="punctuation bracket">(</span><span class="string">&quot;builtin&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="keyword">const</span> <span class="variable">std</span> <span class="operator">=</span> <span class="keyword import">@import</span><span class="punctuation bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="keyword">const</span> <span class="variable">fmt</span> <span class="operator">=</span> <span class="variable">std</span><span class="punctuation delimiter">.</span><span class="variable member">fmt</span><span class="punctuation delimiter">;</span>
<span class="keyword">const</span> <span class="variable">io</span> <span class="operator">=</span> <span class="variable">std</span><span class="punctuation delimiter">.</span><span class="variable member">io</span><span class="punctuation delimiter">;</span>

<span class="keyword">const</span> <span class="variable">Op</span> <span class="operator">=</span> <span class="keyword type">enum</span> <span class="punctuation bracket">{</span>
    <span class="constant">Sum</span><span class="punctuation delimiter">,</span>
    <span class="constant">Mul</span><span class="punctuation delimiter">,</span>
    <span class="constant">Sub</span><span class="punctuation delimiter">,</span>
<span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>

<span class="keyword function">fn</span> <span class="function">ask_user</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span> <span class="operator">!</span><span class="type builtin">i64</span> <span class="punctuation bracket">{</span>
    <span class="keyword">var</span> <span class="variable">buf</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="number">10</span><span class="punctuation bracket">]</span><span class="type builtin">u8</span> <span class="operator">=</span> <span class="constant builtin">undefined</span><span class="punctuation delimiter">;</span>
    <span class="variable">std</span><span class="punctuation delimiter">.</span><span class="variable member">debug</span><span class="punctuation delimiter">.</span><span class="function call">warn</span><span class="punctuation bracket">(</span><span class="string">&quot;A number please: &quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword">const</span> <span class="variable">user_input</span> <span class="operator">=</span> <span class="keyword exception">try</span> <span class="variable">io</span><span class="punctuation delimiter">.</span><span class="function call">readLineSlice</span><span class="punctuation bracket">(</span><span class="variable">buf</span><span class="punctuation bracket">[</span><span class="number">0</span><span class="operator">..</span><span class="punctuation bracket">]</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword return">return</span> <span class="variable">fmt</span><span class="punctuation delimiter">.</span><span class="function call">parseInt</span><span class="punctuation bracket">(</span><span class="type builtin">i64</span><span class="punctuation delimiter">,</span> <span class="variable">user_input</span><span class="punctuation delimiter">,</span> <span class="number">10</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>

<span class="keyword function">fn</span> <span class="function">apply_ops</span><span class="punctuation bracket">(</span><span class="keyword modifier">comptime</span> <span class="variable parameter">operations</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="punctuation bracket">]</span><span class="keyword">const</span> <span class="variable">Op</span><span class="punctuation delimiter">,</span> <span class="variable parameter">num</span><span class="punctuation delimiter">:</span> <span class="type builtin">i64</span><span class="punctuation bracket">)</span> <span class="type builtin">i64</span> <span class="punctuation bracket">{</span>
    <span class="keyword">var</span> <span class="variable">acc</span><span class="punctuation delimiter">:</span> <span class="type builtin">i64</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">;</span>
    <span class="keyword modifier">inline</span> <span class="keyword repeat">for</span> <span class="punctuation bracket">(</span><span class="variable">operations</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">|</span><span class="variable">op</span><span class="punctuation bracket">|</span> <span class="punctuation bracket">{</span>
        <span class="keyword conditional">switch</span> <span class="punctuation bracket">(</span><span class="variable">op</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
            <span class="punctuation delimiter">.</span><span class="constant">Sum</span> <span class="punctuation delimiter">=&gt;</span> <span class="variable">acc</span> <span class="operator">+%=</span> <span class="variable">num</span><span class="punctuation delimiter">,</span>
            <span class="punctuation delimiter">.</span><span class="constant">Mul</span> <span class="punctuation delimiter">=&gt;</span> <span class="variable">acc</span> <span class="operator">*%=</span> <span class="variable">num</span><span class="punctuation delimiter">,</span>
            <span class="punctuation delimiter">.</span><span class="constant">Sub</span> <span class="punctuation delimiter">=&gt;</span> <span class="variable">acc</span> <span class="operator">-%=</span> <span class="variable">num</span><span class="punctuation delimiter">,</span>
        <span class="punctuation bracket">}</span>
    <span class="punctuation bracket">}</span>
    <span class="keyword return">return</span> <span class="variable">acc</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>

<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">main</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span> <span class="operator">!</span><span class="type builtin">void</span> <span class="punctuation bracket">{</span>
    <span class="keyword">const</span> <span class="variable">user_num</span> <span class="operator">=</span> <span class="keyword exception">try</span> <span class="function call">ask_user</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword">const</span> <span class="variable">ops</span> <span class="operator">=</span> <span class="punctuation bracket">[</span><span class="number">4</span><span class="punctuation bracket">]</span><span class="variable">Op</span><span class="punctuation bracket">{</span><span class="punctuation delimiter">.</span><span class="constant">Sum</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="constant">Mul</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="constant">Sub</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="constant">Sub</span><span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>
    <span class="keyword">const</span> <span class="variable">x</span> <span class="operator">=</span> <span class="function call">apply_ops</span><span class="punctuation bracket">(</span><span class="variable">ops</span><span class="punctuation bracket">[</span><span class="number">0</span><span class="operator">..</span><span class="punctuation bracket">]</span><span class="punctuation delimiter">,</span> <span class="variable">user_num</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="variable">std</span><span class="punctuation delimiter">.</span><span class="variable member">debug</span><span class="punctuation delimiter">.</span><span class="function call">warn</span><span class="punctuation bracket">(</span><span class="string">&quot;Result: {}\n&quot;</span><span class="punctuation delimiter">,</span> <span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>The interesting part of this code is the <code>for</code> loop. The <code>inline</code> keyword forces loop unrolling, and inside the loop’s body there is a <code>switch</code> statement that also gets resolved at compile-time. In short, the invocation of <code>apply_ops</code> in the previous example basically resolves to:</p><pre><code class="zig"><span class="keyword">var</span> <span class="variable">acc</span><span class="punctuation delimiter">:</span> <span class="type builtin">i64</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">;</span>
<span class="variable">acc</span> <span class="operator">+%=</span> <span class="variable">num</span><span class="punctuation delimiter">;</span>
acc <span class="operator">*%=</span> <span class="variable">num</span><span class="punctuation delimiter">;</span>
acc <span class="operator">-%=</span> <span class="variable">num</span><span class="punctuation delimiter">;</span>
acc <span class="operator">-%=</span> <span class="variable">num</span><span class="punctuation delimiter">;</span>
<span class="keyword return">return</span> acc<span class="punctuation delimiter">;</span>
</code></pre>
<p>To test that this is really what’s happening, paste the program code in <a href="https://godbolt.org" target="_blank">https://godbolt.org</a>, select Zig as target language, and then select a version of Zig greater than 0.4.0 (at the moment of writing you must select “zig trunk”). Godbolt will compile the code and show you the generated assembly. Right-click on a line of code, and a contextual menu will let you jump to the assembly code that the line corresponds to. You will notice that neither the <code>for</code> loop, nor the <code>switch</code> correspond to any assembly. Remove the <code>inline</code> keyword, and they will now show up.</p><h2>Generics</h2><p>The <code>comptime</code> keyword indicates code regions and values that must be resolved at compile-time. In the previous examples we used it to perform something similar to template metaprogramming, but it can also be used for generic programming, since types are valid compile-time values.</p><h4>Generic functions</h4><p>Since generic programming is tied to <code>comptime</code> arguments, Zig doesn’t have the <em>traditional</em> diamond bracket syntax. Other than that, basic usage of generics is very similar to other languages. The following code is Zig’s implementation of <code>mem.eql</code>, taken from the standard library. It’s used to test two slices for equality.</p><pre><code class="zig"><span class="comment">/// Compares two slices and returns whether they are equal.</span>
<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">eql</span><span class="punctuation bracket">(</span><span class="keyword modifier">comptime</span> <span class="variable parameter">T</span><span class="punctuation delimiter">:</span> <span class="type builtin">type</span><span class="punctuation delimiter">,</span> <span class="variable parameter">a</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="punctuation bracket">]</span><span class="keyword">const</span> <span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable parameter">b</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="punctuation bracket">]</span><span class="keyword">const</span> <span class="variable">T</span><span class="punctuation bracket">)</span> <span class="type builtin">bool</span> <span class="punctuation bracket">{</span>
    <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">a</span><span class="punctuation delimiter">.</span><span class="variable member">len</span> <span class="operator">!=</span> <span class="variable">b</span><span class="punctuation delimiter">.</span><span class="variable member">len</span><span class="punctuation bracket">)</span> <span class="keyword return">return</span> <span class="variable">false</span><span class="punctuation delimiter">;</span>
    <span class="keyword repeat">for</span> <span class="punctuation bracket">(</span><span class="variable">a</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">|</span><span class="variable">item</span><span class="punctuation delimiter">,</span> <span class="variable">index</span><span class="punctuation bracket">|</span> <span class="punctuation bracket">{</span>
        <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">b</span><span class="punctuation bracket">[</span><span class="variable">index</span><span class="punctuation bracket">]</span> <span class="operator">!=</span> <span class="variable">item</span><span class="punctuation bracket">)</span> <span class="keyword return">return</span> <span class="variable">false</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span>
    <span class="keyword return">return</span> <span class="variable">true</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>As you can see, <code>T</code> is a variable of type <code>type</code> and the subsequent arguments use it as a generic parameter. This way it’s possible to use <code>mem.eql</code> with any kind of slice.</p><p>It’s also possible to do introspection on values of type <code>type</code>. In a previous example we parsed an integer number from user input and requested a specific type of integer. The parsing function uses that information to elide some code from its generic implementation.</p><pre><code class="zig"><span class="comment">// This is the line in `apply_ops` where we parsed a number</span>
<span class="keyword return">return</span> <span class="variable">fmt</span><span class="punctuation delimiter">.</span><span class="function call">parseInt</span><span class="punctuation bracket">(</span><span class="type builtin">i64</span><span class="punctuation delimiter">,</span> <span class="variable">user_input</span><span class="punctuation delimiter">,</span> <span class="number">10</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>

<span class="comment">// This is the stdlib implementation of `parseInt`</span>
<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">parseInt</span><span class="punctuation bracket">(</span><span class="keyword modifier">comptime</span> <span class="variable parameter">T</span><span class="punctuation delimiter">:</span> <span class="type builtin">type</span><span class="punctuation delimiter">,</span> <span class="variable parameter">buf</span><span class="punctuation delimiter">:</span> <span class="punctuation bracket">[</span><span class="punctuation bracket">]</span><span class="keyword">const</span> <span class="type builtin">u8</span><span class="punctuation delimiter">,</span> <span class="variable parameter">radix</span><span class="punctuation delimiter">:</span> <span class="type builtin">u8</span><span class="punctuation bracket">)</span> <span class="operator">!</span><span class="variable">T</span> <span class="punctuation bracket">{</span>
    <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="operator">!</span><span class="variable">T</span><span class="punctuation delimiter">.</span><span class="variable member">is_signed</span><span class="punctuation bracket">)</span> <span class="keyword return">return</span> <span class="function call">parseUnsigned</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable">buf</span><span class="punctuation delimiter">,</span> <span class="variable">radix</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">buf</span><span class="punctuation delimiter">.</span><span class="variable member">len</span> <span class="operator">==</span> <span class="number">0</span><span class="punctuation bracket">)</span> <span class="keyword return">return</span> <span class="function call">T</span><span class="punctuation bracket">(</span><span class="number">0</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">buf</span><span class="punctuation bracket">[</span><span class="number">0</span><span class="punctuation bracket">]</span> <span class="operator">==</span> <span class="character">&apos;-&apos;</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
        <span class="keyword return">return</span> <span class="variable">math</span><span class="punctuation delimiter">.</span><span class="function call">negate</span><span class="punctuation bracket">(</span><span class="keyword exception">try</span> <span class="function call">parseUnsigned</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable">buf</span><span class="punctuation bracket">[</span><span class="number">1</span><span class="operator">..</span><span class="punctuation bracket">]</span><span class="punctuation delimiter">,</span> <span class="variable">radix</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span> <span class="keyword conditional">else</span> <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">buf</span><span class="punctuation bracket">[</span><span class="number">0</span><span class="punctuation bracket">]</span> <span class="operator">==</span> <span class="character">&apos;+&apos;</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
        <span class="keyword return">return</span> <span class="function call">parseUnsigned</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable">buf</span><span class="punctuation bracket">[</span><span class="number">1</span><span class="operator">..</span><span class="punctuation bracket">]</span><span class="punctuation delimiter">,</span> <span class="variable">radix</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span> <span class="keyword conditional">else</span> <span class="punctuation bracket">{</span>
        <span class="keyword return">return</span> <span class="function call">parseUnsigned</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable">buf</span><span class="punctuation delimiter">,</span> <span class="variable">radix</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span>
<span class="punctuation bracket">}</span>
</code></pre>
<h4>Generic structs</h4><p>Before describing how to create generic structs, here’s a brief introduction on how structs work in Zig.</p><pre><code class="zig"><span class="keyword">const</span> <span class="variable">std</span> <span class="operator">=</span> <span class="keyword import">@import</span><span class="punctuation bracket">(</span><span class="string">&quot;std&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="keyword">const</span> <span class="variable">math</span> <span class="operator">=</span> <span class="variable">std</span><span class="punctuation delimiter">.</span><span class="variable member">math</span><span class="punctuation delimiter">;</span>
<span class="keyword">const</span> <span class="variable">assert</span> <span class="operator">=</span> <span class="variable">std</span><span class="punctuation delimiter">.</span><span class="variable member">debug</span><span class="punctuation delimiter">.</span><span class="variable member">assert</span><span class="punctuation delimiter">;</span>

<span class="comment">// A struct definition doesn&apos;t include a name.</span>
<span class="comment">// Assigning the struct to a variable gives it a name.</span>
<span class="keyword">const</span> <span class="variable">Point</span> <span class="operator">=</span> <span class="keyword type">struct</span> <span class="punctuation bracket">{</span>
    <span class="variable member">x</span><span class="punctuation delimiter">:</span> <span class="type builtin">f64</span><span class="punctuation delimiter">,</span>
    <span class="variable member">y</span><span class="punctuation delimiter">:</span> <span class="type builtin">f64</span><span class="punctuation delimiter">,</span>
    <span class="variable member">z</span><span class="punctuation delimiter">:</span> <span class="type builtin">f64</span><span class="punctuation delimiter">,</span>
		
    <span class="comment">// A struct definition can also contain namespaced functions.</span>
    <span class="comment">// This has no impact on the struct layout.</span>
    <span class="comment">// Struct functions that take a Self parameter, when</span>
    <span class="comment">// invoked through a struct instance, will automatically</span>
    <span class="comment">// fill the first argument, just like methods do.</span>
    <span class="keyword">const</span> <span class="variable">Self</span> <span class="operator">=</span> <span class="keyword import">@This</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">distance</span><span class="punctuation bracket">(</span><span class="variable parameter">self</span><span class="punctuation delimiter">:</span> <span class="type">Self</span><span class="punctuation delimiter">,</span> <span class="variable parameter">p</span><span class="punctuation delimiter">:</span> <span class="type">Point</span><span class="punctuation bracket">)</span> <span class="type builtin">f64</span> <span class="punctuation bracket">{</span>
        <span class="keyword">const</span> <span class="variable">x2</span> <span class="operator">=</span> <span class="variable">math</span><span class="punctuation delimiter">.</span><span class="function call">pow</span><span class="punctuation bracket">(</span><span class="type builtin">f64</span><span class="punctuation delimiter">,</span> <span class="variable">self</span><span class="punctuation delimiter">.</span><span class="variable member">x</span> <span class="operator">-</span> <span class="variable">p</span><span class="punctuation delimiter">.</span><span class="variable member">x</span><span class="punctuation delimiter">,</span> <span class="number">2</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
        <span class="keyword">const</span> <span class="variable">y2</span> <span class="operator">=</span> <span class="variable">math</span><span class="punctuation delimiter">.</span><span class="function call">pow</span><span class="punctuation bracket">(</span><span class="type builtin">f64</span><span class="punctuation delimiter">,</span> <span class="variable">self</span><span class="punctuation delimiter">.</span><span class="variable member">y</span> <span class="operator">-</span> <span class="variable">p</span><span class="punctuation delimiter">.</span><span class="variable member">y</span><span class="punctuation delimiter">,</span> <span class="number">2</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
        <span class="keyword">const</span> <span class="variable">z2</span> <span class="operator">=</span> <span class="variable">math</span><span class="punctuation delimiter">.</span><span class="function call">pow</span><span class="punctuation bracket">(</span><span class="type builtin">f64</span><span class="punctuation delimiter">,</span> <span class="variable">self</span><span class="punctuation delimiter">.</span><span class="variable member">z</span> <span class="operator">-</span> <span class="variable">p</span><span class="punctuation delimiter">.</span><span class="variable member">z</span><span class="punctuation delimiter">,</span> <span class="number">2</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
        <span class="keyword return">return</span> <span class="variable">math</span><span class="punctuation delimiter">.</span><span class="function call">sqrt</span><span class="punctuation bracket">(</span><span class="variable">x2</span> <span class="operator">+</span> <span class="variable">y2</span> <span class="operator">+</span> <span class="variable">z2</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span>
<span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>

<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">main</span><span class="punctuation bracket">(</span><span class="punctuation bracket">)</span> <span class="operator">!</span><span class="type builtin">void</span> <span class="punctuation bracket">{</span>
    <span class="keyword">const</span> <span class="variable">p1</span> <span class="operator">=</span> <span class="variable">Point</span><span class="punctuation bracket">{</span> <span class="punctuation delimiter">.</span><span class="variable member">x</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="variable member">y</span> <span class="operator">=</span> <span class="number">2</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="variable member">z</span> <span class="operator">=</span> <span class="number">8</span> <span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>
    <span class="keyword">const</span> <span class="variable">p2</span> <span class="operator">=</span> <span class="variable">Point</span><span class="punctuation bracket">{</span> <span class="punctuation delimiter">.</span><span class="variable member">x</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="variable member">y</span> <span class="operator">=</span> <span class="number">6</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="variable member">z</span> <span class="operator">=</span> <span class="number">8</span> <span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>
    
    <span class="function call">assert</span><span class="punctuation bracket">(</span><span class="variable">p1</span><span class="punctuation delimiter">.</span><span class="function call">distance</span><span class="punctuation bracket">(</span><span class="variable">p2</span><span class="punctuation bracket">)</span> <span class="operator">==</span> <span class="number">4</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="function call">assert</span><span class="punctuation bracket">(</span><span class="variable">Point</span><span class="punctuation delimiter">.</span><span class="function call">distance</span><span class="punctuation bracket">(</span><span class="variable">p1</span><span class="punctuation delimiter">,</span> <span class="variable">p2</span><span class="punctuation bracket">)</span> <span class="operator">==</span> <span class="number">4</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>

</code></pre>
<p>We’re now ready to talk about generic structs. To create a generic struct, all you have to do is create a function that takes a type argument and use that argument in your struct definition. Here’s an example lifted from Zig’s documentation. It’s a doubly-linked intrusive list.</p><pre><code class="zig"><span class="keyword function">fn</span> <span class="function">LinkedList</span><span class="punctuation bracket">(</span><span class="keyword modifier">comptime</span> <span class="variable parameter">T</span><span class="punctuation delimiter">:</span> <span class="type builtin">type</span><span class="punctuation bracket">)</span> <span class="type builtin">type</span> <span class="punctuation bracket">{</span>
    <span class="keyword return">return</span> <span class="keyword type">struct</span> <span class="punctuation bracket">{</span>
        <span class="keyword modifier">pub</span> <span class="keyword">const</span> <span class="variable">Node</span> <span class="operator">=</span> <span class="keyword type">struct</span> <span class="punctuation bracket">{</span>
            <span class="variable member">prev</span><span class="punctuation delimiter">:</span> <span class="operator">?</span><span class="operator">*</span><span class="variable">Node</span> <span class="operator">=</span> <span class="constant builtin">null</span><span class="punctuation delimiter">,</span>
            <span class="variable member">next</span><span class="punctuation delimiter">:</span> <span class="operator">?</span><span class="operator">*</span><span class="variable">Node</span> <span class="operator">=</span> <span class="constant builtin">null</span><span class="punctuation delimiter">,</span>
            <span class="variable member">data</span><span class="punctuation delimiter">:</span> <span class="variable">T</span><span class="punctuation delimiter">,</span>
        <span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>

        <span class="variable member">first</span><span class="punctuation delimiter">:</span> <span class="operator">?</span><span class="operator">*</span><span class="variable">Node</span> <span class="operator">=</span> <span class="constant builtin">null</span><span class="punctuation delimiter">,</span>
        <span class="variable member">last</span><span class="punctuation delimiter">:</span> <span class="operator">?</span><span class="operator">*</span><span class="variable">Node</span> <span class="operator">=</span> <span class="constant builtin">null</span><span class="punctuation delimiter">,</span>
        <span class="variable member">len</span><span class="punctuation delimiter">:</span> <span class="type builtin">usize</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">,</span>
    <span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>The function returns a <code>type</code>, which means it can only be called at comptime. It defines two structs:</p><ul><li>The main <code>LinkedList</code> struct</li><li>The <code>Node</code> struct, namespaced inside the main struct</li></ul><p>Just like structs can namespace functions, they can also namespace variables. This is especially useful for introspection when creating composite types. Here’s how <code>LinkedList</code> can be composed with our previous <code>Point</code> struct.</p><pre><code class="zig"><span class="comment">// To try this code, paste both definitions in the same file.</span>
<span class="keyword">const</span> <span class="variable">PointList</span> <span class="operator">=</span> <span class="function call">LinkedList</span><span class="punctuation bracket">(</span><span class="variable">Point</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
<span class="keyword">const</span> <span class="variable">p</span> <span class="operator">=</span> <span class="variable">Point</span><span class="punctuation bracket">{</span> <span class="punctuation delimiter">.</span><span class="variable member">x</span> <span class="operator">=</span> <span class="number">0</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="variable member">y</span> <span class="operator">=</span> <span class="number">2</span><span class="punctuation delimiter">,</span> <span class="punctuation delimiter">.</span><span class="variable member">z</span> <span class="operator">=</span> <span class="number">8</span> <span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>

<span class="keyword">var</span> <span class="variable">my_list</span> <span class="operator">=</span> <span class="variable">PointList</span><span class="punctuation bracket">{</span><span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>

<span class="comment">// A complete implementation would offer an `append` method.</span>
<span class="comment">// For now let&apos;s add the new node manually.</span>
<span class="keyword">var</span> <span class="variable">node</span> <span class="operator">=</span> <span class="variable">PointList</span><span class="punctuation delimiter">.</span><span class="variable member">Node</span><span class="punctuation bracket">{</span> <span class="punctuation delimiter">.</span><span class="variable member">data</span> <span class="operator">=</span> <span class="variable">p</span> <span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>
<span class="variable">my_list</span><span class="punctuation delimiter">.</span><span class="variable member">first</span> <span class="operator">=</span> <span class="operator">&amp;</span><span class="variable">node</span><span class="punctuation delimiter">;</span>
my_list<span class="punctuation delimiter">.</span><span class="variable member">last</span> <span class="operator">=</span> <span class="operator">&amp;</span><span class="variable">node</span><span class="punctuation delimiter">;</span>
my_list<span class="punctuation delimiter">.</span><span class="variable member">len</span> <span class="operator">=</span> <span class="number">1</span><span class="punctuation delimiter">;</span>
</code></pre>
<p>The Zig standard library contains <a href="https://github.com/ziglang/zig/blob/ddf7942aaa6a41296d9338423dcdfb93b915e4df/std/linked_list.zig" target="_blank">a couple of fleshed out implementations of linked lists</a>.</p><h2>Compile-time reflection</h2><p>Now that we have covered all the basics, we can finally move onto the things that make Zig metaprogramming truly powerful and fun to use.</p><p>We already saw an example of reflection when <code>parseInt</code> was checking <code>T.is_signed</code>, but in this section I want to focus on a more advanced usage of reflection. I’ll introduce the concept with a code sample.</p><pre><code class="zig"><span class="keyword function">fn</span> <span class="function">make_couple_of</span><span class="punctuation bracket">(</span><span class="variable parameter">x</span><span class="punctuation delimiter">:</span> <span class="type builtin">anytype</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">[</span><span class="number">2</span><span class="punctuation bracket">]</span><span class="function builtin">@typeOf</span><span class="punctuation bracket">(</span><span class="variable">x</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
    <span class="keyword return">return</span> <span class="punctuation bracket">[</span><span class="number">2</span><span class="punctuation bracket">]</span><span class="function builtin">@typeOf</span><span class="punctuation bracket">(</span><span class="variable">x</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span><span class="variable">x</span><span class="punctuation delimiter">,</span> <span class="variable">x</span><span class="punctuation bracket">}</span><span class="punctuation delimiter">;</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>This – mostly useless – function can take any value as input and creates an array that contains two copies of it. The following invocations are all correct.</p><pre><code class="zig"><span class="function call">make_couple_of</span><span class="punctuation bracket">(</span><span class="number">5</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span> <span class="comment">// creates [2]comptime_int{5, 5}</span>
<span class="function call">make_couple_of</span><span class="punctuation bracket">(</span><span class="type builtin">i32</span><span class="punctuation bracket">(</span><span class="number">5</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span> <span class="comment">// creates [2]i32{5, 5}</span>
<span class="function call">make_couple_of</span><span class="punctuation bracket">(</span><span class="type builtin">u8</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span> <span class="comment">// creates [2]type{u8, u8}</span>
<span class="function call">make_couple_of</span><span class="punctuation bracket">(</span><span class="type builtin">type</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span> <span class="comment">// creates [2]type{type, type}</span>
<span class="function call">make_couple_of</span><span class="punctuation bracket">(</span><span class="function call">make_couple_of</span><span class="punctuation bracket">(</span><span class="string">&quot;hi&quot;</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span> 
<span class="comment">// creates [2][2][2]u8{[2][2]u8{&quot;hi&quot;,&quot;hi&quot;}, [2][2]u8{&quot;hi&quot;,&quot;hi&quot;}}</span>
</code></pre>
<p>Arguments of type <code>anytype</code> are very powerful and allow construction of optimized and yet “dynamic” functions. For the next example I’ll lift some more code from the standard library to showcase a more useful use of this functionality.</p><p>The following code is the implementation of <code>math.sqrt</code>, which we used in a previous example to compute the euclidean distance between two points.</p><pre><code class="zig"><span class="comment">// I moved part of the original definition to</span>
<span class="comment">// a separate function for better readability.</span>
<span class="keyword function">fn</span> <span class="function">decide_return_type</span><span class="punctuation bracket">(</span><span class="keyword modifier">comptime</span> <span class="variable parameter">T</span><span class="punctuation delimiter">:</span> <span class="type builtin">type</span><span class="punctuation bracket">)</span> <span class="type builtin">type</span> <span class="punctuation bracket">{</span>
    <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="function builtin">@typeId</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation bracket">)</span> <span class="operator">==</span> <span class="variable">TypeId</span><span class="punctuation delimiter">.</span><span class="variable member">Int</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
        <span class="keyword return">return</span> <span class="function builtin">@IntType</span><span class="punctuation bracket">(</span><span class="variable">false</span><span class="punctuation delimiter">,</span> <span class="variable">T</span><span class="punctuation delimiter">.</span><span class="variable member">bit_count</span> <span class="operator">/</span> <span class="number">2</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span> <span class="keyword conditional">else</span> <span class="punctuation bracket">{</span>
        <span class="keyword return">return</span> <span class="variable">T</span><span class="punctuation delimiter">;</span>
    <span class="punctuation bracket">}</span>
<span class="punctuation bracket">}</span>

<span class="keyword modifier">pub</span> <span class="keyword function">fn</span> <span class="function">sqrt</span><span class="punctuation bracket">(</span><span class="variable parameter">x</span><span class="punctuation delimiter">:</span> <span class="type builtin">anytype</span><span class="punctuation bracket">)</span> <span class="function call">decide_return_type</span><span class="punctuation bracket">(</span><span class="function builtin">@typeOf</span><span class="punctuation bracket">(</span><span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
    <span class="keyword">const</span> <span class="variable">T</span> <span class="operator">=</span> <span class="keyword import">@typeOf</span><span class="punctuation bracket">(</span><span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
    <span class="keyword conditional">switch</span> <span class="punctuation bracket">(</span><span class="function builtin">@typeId</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
        <span class="variable">TypeId</span><span class="punctuation delimiter">.</span><span class="variable member">ComptimeFloat</span> <span class="punctuation delimiter">=&gt;</span> <span class="keyword return">return</span> <span class="function call">T</span><span class="punctuation bracket">(</span><span class="function builtin">@sqrt</span><span class="punctuation bracket">(</span><span class="type builtin">f64</span><span class="punctuation delimiter">,</span> <span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">,</span>
        <span class="variable">TypeId</span><span class="punctuation delimiter">.</span><span class="variable member">Float</span> <span class="punctuation delimiter">=&gt;</span> <span class="keyword return">return</span> <span class="function builtin">@sqrt</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">,</span>
        <span class="variable">TypeId</span><span class="punctuation delimiter">.</span><span class="variable member">ComptimeInt</span> <span class="punctuation delimiter">=&gt;</span> <span class="keyword modifier">comptime</span> <span class="punctuation bracket">{</span>
            <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">x</span> <span class="operator">&gt;</span> <span class="function call">maxInt</span><span class="punctuation bracket">(</span><span class="type builtin">u128</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
                <span class="function builtin">@compileError</span><span class="punctuation bracket">(</span>
                	<span class="string">&quot;sqrt not implemented for &quot;</span> <span class="operator">++</span> 
                	<span class="string">&quot;comptime_int greater than 128 bits&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
            <span class="punctuation bracket">}</span>
            <span class="keyword conditional">if</span> <span class="punctuation bracket">(</span><span class="variable">x</span> <span class="operator">&lt;</span> <span class="number">0</span><span class="punctuation bracket">)</span> <span class="punctuation bracket">{</span>
                <span class="function builtin">@compileError</span><span class="punctuation bracket">(</span><span class="string">&quot;sqrt on negative number&quot;</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
            <span class="punctuation bracket">}</span>
            <span class="keyword return">return</span> <span class="function call">T</span><span class="punctuation bracket">(</span><span class="function call">sqrt_int</span><span class="punctuation bracket">(</span><span class="type builtin">u128</span><span class="punctuation delimiter">,</span> <span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">;</span>
        <span class="punctuation bracket">}</span><span class="punctuation delimiter">,</span>
        <span class="variable">TypeId</span><span class="punctuation delimiter">.</span><span class="variable member">Int</span> <span class="punctuation delimiter">=&gt;</span> <span class="keyword return">return</span> <span class="function call">sqrt_int</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation delimiter">,</span> <span class="variable">x</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">,</span>
        <span class="keyword conditional">else</span> <span class="punctuation delimiter">=&gt;</span> <span class="function builtin">@compileError</span><span class="punctuation bracket">(</span><span class="string">&quot;not implemented for &quot;</span> <span class="operator">++</span> <span class="function builtin">@typeName</span><span class="punctuation bracket">(</span><span class="variable">T</span><span class="punctuation bracket">)</span><span class="punctuation bracket">)</span><span class="punctuation delimiter">,</span>
    <span class="punctuation bracket">}</span>
<span class="punctuation bracket">}</span>
</code></pre>
<p>The return type of this function is a bit peculiar. If you look at the signature of <code>sqrt</code>, it’s calling a function in the place where it should be declaring the return type. This is allowed in Zig. The original code actually inlines an <code>if</code> expression, but I moved it to a separate function for better readability.</p><p>So what is <code>sqrt</code> trying to do with its return type? It’s applying a small optimization when we’re passing in an integer value. In that case the function declares its return type as an <strong>unsigned</strong> integer with <strong>half the bit size</strong> of the original input. This means that, if we’re passing in an <code>i64</code> value, the function will return an <code>u32</code> value. This makes sense given what the square root function does. The rest of the declaration then uses reflection to further specialize and report compile-time errors where appropriate.</p><h2>In conclusion</h2><p>Compile-time execution is great, especially when the language is very expressive. Without good compile-time metaprogramming, one must resort to macros or codegen, or worse, do a lot of useless work at runtime.</p><p>If you want to see one more cool example of what can be done at compile-time in Zig, <a href="https://andrewkelley.me/post/string-matching-comptime-perfect-hashing-zig.html" target="_blank">take a look at this blog post by Andrew himself</a>. In it, he uses some the aforementioned techniques to generate a perfect hashing function for a compile-time known list of strings. The result is that the user can create a switch that matches strings in <code>O(1)</code>. The code is very easy to understand, and he offers some insight on how all the other minor features make user abstractions easy, fun and safe to use.</p></div>
  <div id="footnotes"></div>
  <hr>
  <div id="prev-next">
    <span>
      <a href="/blog/simple-not-just-easy/">←
        <span>I Want Simple, Not Just Easy</span></a>
    </span>
    <span>&nbsp; • &nbsp;</span>
    <span>
      <a href="/blog/why-go-and-not-rust/"><span>Why Go and not Rust?</span>
        →</a>
    </span>
    <small>&nbsp; or &nbsp;</small>
    <small>
      <a href="/">Back to the Homepage</a>
    </small>
  </div>

    </div>
  </body>
</html>